<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AUHSD Production Record</title>
  
  <!-- MENU DATABASE -->
  <script src="menu-database.js"></script>
  
  <!-- jsPDF for PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --brand:#0b2d5c;
      --brand2:#004a99;
      --ink:#0f172a;
      --muted:#64748b;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    
    body{
      font-family: Arial, sans-serif;
      padding:20px;
      background:#f5f5f5;
      color:#000;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      background:#fff;
      padding:30px;
      border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    h1{
      text-align:center;
      color:var(--brand);
      margin-bottom:10px;
    }

    .subtitle{
      text-align:center;
      color:#666;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:1px;
      margin-bottom:20px;
    }

    .info-grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:15px;
      margin-bottom:20px;
      padding:15px;
      background:#f9f9f9;
      border-radius:5px;
    }

    .info-item{
      display:flex;
      flex-direction:column;
    }

    .info-label{
      font-size:11px;
      font-weight:bold;
      color:#666;
      margin-bottom:5px;
      text-transform:uppercase;
    }

    .info-value{
      font-size:14px;
      font-weight:bold;
      color:#000;
    }

    input, select{
      width:100%;
      padding:8px;
      border:1px solid #ddd;
      border-radius:4px;
      font-size:13px;
    }

    .section{
      margin-bottom:30px;
    }

    .section-header{
      background:var(--brand2);
      color:#fff;
      padding:10px 15px;
      font-weight:bold;
      border-radius:5px 5px 0 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .add-btn{
      background:#fff;
      color:var(--brand2);
      border:none;
      padding:5px 15px;
      border-radius:3px;
      cursor:pointer;
      font-weight:bold;
      font-size:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-bottom:10px;
    }

    th, td{
      border:1px solid #000;
      padding:8px;
      text-align:center;
      font-size:12px;
    }

    th{
      background:#e0e0e0;
      font-weight:bold;
    }

    td input{
      width:100%;
      border:none;
      padding:4px;
      text-align:center;
      font-size:12px;
    }

    .item-col{
      text-align:left !important;
      width:25%;
    }

    .item-col input{
      text-align:left;
    }

    .del-btn{
      background:#dc3545;
      color:#fff;
      border:none;
      padding:3px 8px;
      border-radius:3px;
      cursor:pointer;
      font-size:11px;
    }

    .total-row{
      background:#f0f0f0;
      font-weight:bold;
    }

    .buttons{
      display:flex;
      gap:10px;
      margin-top:20px;
    }

    .btn{
      padding:10px 20px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      font-weight:bold;
    }

    .btn-primary{ background:#007bff; color:#fff; }
    .btn-success{ background:#28a745; color:#fff; }
    .btn-warning{ background:#ffc107; color:#000; }
    .btn-secondary{ background:#6c757d; color:#fff; }
    .btn-danger{ background:#dc3545; color:#fff; }

    @media print{
      .buttons, .add-btn, .del-btn{ display:none !important; }
      body{ padding:10px; }
      input{ border:none !important; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="subtitle">AUHSD Food Services</div>
    <h1>Daily Production Record</h1>

    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">School</span>
        <div class="info-value" id="school-name">‚Äî</div>
      </div>
      <div class="info-item">
        <span class="info-label">Type</span>
        <div class="info-value" id="school-type">‚Äî</div>
      </div>
      <div class="info-item">
        <span class="info-label">Date</span>
        <input type="date" id="record-date" onchange="saveData()" />
      </div>
      <div class="info-item">
        <span class="info-label">Meal</span>
        <select id="meal-type" onchange="loadSections()">
          <option>Breakfast</option>
          <option>Lunch</option>
          <option>Salad Bar</option>
        </select>
      </div>
      <div class="info-item">
        <span class="info-label">Students Served</span>
        <input type="number" id="students" placeholder="0" oninput="saveData()" />
      </div>
      <div class="info-item">
        <span class="info-label">Adult Meals</span>
        <input type="number" id="adults" placeholder="0" oninput="saveData()" />
      </div>
      <div class="info-item" style="grid-column: span 2;">
        <span class="info-label">Manager/Clerk Name</span>
        <input type="text" id="manager" placeholder="Enter name" oninput="saveData()" />
      </div>
      <div class="info-item">
        <span class="info-label">Status</span>
        <div class="info-value" id="status">DRAFT</div>
      </div>
    </div>

    <div id="sections-container"></div>

    <div class="buttons">
      <button class="btn btn-success" onclick="generatePDF()">üìÑ Generate PDF Report</button>
      <button class="btn btn-warning" onclick="lockRecord()">üîí Complete & Lock</button>
      <button class="btn btn-secondary" onclick="goBack()">‚Üê Back</button>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    
    const SECTIONS = {
      "Elementary": {
        "Breakfast": ["GRAIN (M/MA counted as Grains)", "FRUIT", "CONDIMENTS", "MILK & MILK SUBSTITUTES (8OZ)", "Special Diets (from DFC)"],
        "Lunch": ["GRAIN & MEAT/MEAT ALT", "FRUIT (1/2 CUP) & VEGETABLE (1/2 CUP)", "GRAIN-BASED DESSERT", "CONDIMENTS", "MILK & MILK SUBSTITUTES (8OZ)", "Special Diets (from DFC)"]
      },
      "High School": {
        "Breakfast": ["GRAINS", "FRUIT", "MILK", "EXTRA FOOD CONDIMENTS"],
        "Lunch": ["ENTREE", "VEGETABLE", "FRUIT", "MILK", "EXTRA FOOD CONDIMENTS"],
        "Salad Bar": ["ENTREE", "MILK", "VEGETABLE", "FRUIT", "EXTRAS", "Condiments (Pre-packaged)"]
      }
    };

    let schoolType = "";
    let currentMeal = "Breakfast";

    function init(){
      const school = localStorage.getItem("currentSchool") || "Unknown";
      schoolType = localStorage.getItem("schoolType") || "Elementary";
      
      document.getElementById("school-name").textContent = school;
      document.getElementById("school-type").textContent = schoolType;
      document.getElementById("record-date").valueAsDate = new Date();
      
      loadSections();
      loadData();
    }

    function loadSections(){
      currentMeal = document.getElementById("meal-type").value;
      const container = document.getElementById("sections-container");
      container.innerHTML = "";
      
      const sections = SECTIONS[schoolType]?.[currentMeal] || [];
      
      sections.forEach(sec => {
        const div = document.createElement("div");
        div.className = "section";
        
        const header = document.createElement("div");
        header.className = "section-header";
        header.innerHTML = `<span>${sec}</span><button class="add-btn" onclick="addRow('${sec.replace(/'/g, "\\'")}')">+ Add Item</button>`;
        
        const table = document.createElement("table");
        table.innerHTML = getTableHeader();
        table.dataset.section = sec;
        
        const tbody = document.createElement("tbody");
        table.appendChild(tbody);
        
        div.appendChild(header);
        div.appendChild(table);
        container.appendChild(div);
        
        // CREATE DATALIST IMMEDIATELY FOR EACH SECTION
        createDatalist(sec);
      });
      
      loadData();
    }

    function getTableHeader(){
      if (schoolType === "High School") {
        if (currentMeal === "Salad Bar") {
          return `<thead><tr>
            <th class="item-col">Menu Item</th>
            <th>Item/Recipe #</th>
            <th>Cook Temp/Time</th>
            <th>Serve Temp/Time</th>
            <th>Serving Size</th>
            <th>Meal Contrib</th>
            <th>Est Portions</th>
            <th>New Portions</th>
            <th>Actual Served</th>
            <th>Tossed</th>
            <th>For Future</th>
            <th>End Temp/Time</th>
            <th>Del</th>
          </tr></thead>`;
        } else {
          return `<thead><tr>
            <th class="item-col">Menu Item</th>
            <th>Recipe #</th>
            <th>Cook Temp/Time</th>
            <th>Serve Temp/Time</th>
            <th>Serving Size</th>
            <th>Meal Contrib</th>
            <th>Est Portions</th>
            <th>Prev Portions</th>
            <th>Prev Reheat</th>
            <th>New Portions</th>
            <th>Total Prep</th>
            <th>Actual Served</th>
            <th>Tossed</th>
            <th>For Future</th>
            <th>End Temp/Time</th>
            <th>Del</th>
          </tr></thead>`;
        }
      } else {
        return `<thead><tr>
          <th class="item-col">Menu Item</th>
          <th>Prepared</th>
          <th>Leftover</th>
          <th>Discard</th>
          <th>Served</th>
          <th>Temp 1</th>
          <th>Temp 2</th>
          <th>Temp 3</th>
          <th>Del</th>
        </tr></thead>`;
      }
    }

    function createDatalist(section){
      const listId = `items-${section.replace(/\s+/g, '-')}`;
      const existingList = document.getElementById(listId);
      if (existingList) return; // Already exists
      
      const datalist = document.createElement("datalist");
      datalist.id = listId;
      
      if (schoolType === "High School") {
        const mealKey = currentMeal.toLowerCase().replace(" ", "_");
        const items = MENU_DATABASE?.high_school?.[mealKey] || [];
        
        items.forEach(item => {
          const option = document.createElement("option");
          option.value = item.item;
          option.dataset.recipe = item.recipe || item.item_number || "";
          option.dataset.serving = item.serving || "";
          option.dataset.contribution = item.contribution || "";
          datalist.appendChild(option);
        });
      } else {
        const items = MENU_DATABASE?.elementary?.breakfast || [];
        items.forEach(item => {
          const option = document.createElement("option");
          option.value = item;
          datalist.appendChild(option);
        });
      }
      
      document.body.appendChild(datalist);
    }

    function addRow(section){
      const table = document.querySelector(`table[data-section="${section}"]`);
      const tbody = table.querySelector("tbody");
      const row = tbody.insertRow();
      
      const listId = `items-${section.replace(/\s+/g, '-')}`;
      
      if (schoolType === "High School") {
        if (currentMeal === "Salad Bar") {
          row.innerHTML = `
            <td class="item-col"><input type="text" class="item" list="${listId}" oninput="fillRecipe(this);saveData()" /></td>
            <td><input type="text" class="recipe" readonly /></td>
            <td><input type="text" class="cook" oninput="saveData()" /></td>
            <td><input type="text" class="serve" oninput="saveData()" /></td>
            <td><input type="text" class="serving" readonly /></td>
            <td><input type="text" class="contrib" readonly /></td>
            <td><input type="number" class="est" value="0" oninput="saveData()" /></td>
            <td><input type="number" class="new" value="0" oninput="calc(this);saveData()" /></td>
            <td><input type="number" class="served" value="0" oninput="calc(this);saveData()" /></td>
            <td><input type="number" class="tossed" value="0" oninput="calc(this);saveData()" /></td>
            <td class="future">0</td>
            <td><input type="text" class="end" oninput="saveData()" /></td>
            <td><button class="del-btn" onclick="delRow(this)">X</button></td>
          `;
        } else {
          row.innerHTML = `
            <td class="item-col"><input type="text" class="item" list="${listId}" oninput="fillRecipe(this);saveData()" /></td>
            <td><input type="text" class="recipe" readonly /></td>
            <td><input type="text" class="cook" oninput="saveData()" /></td>
            <td><input type="text" class="serve" oninput="saveData()" /></td>
            <td><input type="text" class="serving" readonly /></td>
            <td><input type="text" class="contrib" readonly /></td>
            <td><input type="number" class="est" value="0" oninput="saveData()" /></td>
            <td><input type="number" class="prev" value="0" oninput="calc(this);saveData()" /></td>
            <td><input type="text" class="prev-reheat" oninput="saveData()" /></td>
            <td><input type="number" class="new" value="0" oninput="calc(this);saveData()" /></td>
            <td class="total">0</td>
            <td><input type="number" class="served" value="0" oninput="calc(this);saveData()" /></td>
            <td><input type="number" class="tossed" value="0" oninput="calc(this);saveData()" /></td>
            <td class="future">0</td>
            <td><input type="text" class="end" oninput="saveData()" /></td>
            <td><button class="del-btn" onclick="delRow(this)">X</button></td>
          `;
        }
      } else {
        row.innerHTML = `
          <td class="item-col"><input type="text" class="item" list="${listId}" oninput="saveData()" /></td>
          <td><input type="number" class="prep" value="0" oninput="calc(this);saveData()" /></td>
          <td><input type="number" class="left" value="0" oninput="calc(this);saveData()" /></td>
          <td><input type="number" class="disc" value="0" oninput="calc(this);saveData()" /></td>
          <td class="served">0</td>
          <td><input type="text" class="t1" oninput="saveData()" /></td>
          <td><input type="text" class="t2" oninput="saveData()" /></td>
          <td><input type="text" class="t3" oninput="saveData()" /></td>
          <td><button class="del-btn" onclick="delRow(this)">X</button></td>
        `;
      }
    }

    function fillRecipe(input){
      const row = input.closest("tr");
      const section = input.closest("table").dataset.section;
      const listId = `items-${section.replace(/\s+/g, '-')}`;
      const datalist = document.getElementById(listId);
      
      if (!datalist) return;
      
      const option = Array.from(datalist.options).find(opt => opt.value === input.value);
      if (option) {
        const recipeInput = row.querySelector(".recipe");
        const servingInput = row.querySelector(".serving");
        const contribInput = row.querySelector(".contrib");
        
        if (recipeInput) recipeInput.value = option.dataset.recipe || "";
        if (servingInput) servingInput.value = option.dataset.serving || "";
        if (contribInput) contribInput.value = option.dataset.contribution || "";
      }
    }

    function calc(el){
      const row = el.closest("tr");
      
      if (schoolType === "High School") {
        if (currentMeal === "Salad Bar") {
          const newP = parseFloat(row.querySelector(".new").value) || 0;
          const served = parseFloat(row.querySelector(".served").value) || 0;
          const tossed = parseFloat(row.querySelector(".tossed").value) || 0;
          row.querySelector(".future").textContent = newP - served - tossed;
        } else {
          const prev = parseFloat(row.querySelector(".prev").value) || 0;
          const newP = parseFloat(row.querySelector(".new").value) || 0;
          const total = prev + newP;
          row.querySelector(".total").textContent = total;
          
          const served = parseFloat(row.querySelector(".served").value) || 0;
          const tossed = parseFloat(row.querySelector(".tossed").value) || 0;
          row.querySelector(".future").textContent = total - served - tossed;
        }
      } else {
        const prep = parseFloat(row.querySelector(".prep").value) || 0;
        const left = parseFloat(row.querySelector(".left").value) || 0;
        const disc = parseFloat(row.querySelector(".disc").value) || 0;
        row.querySelector(".served").textContent = prep - left - disc;
      }
    }

    function delRow(btn){
      if (confirm("Delete this item?")) {
        btn.closest("tr").remove();
        saveData();
      }
    }

    function saveData(){
      const key = getKey();
      const data = {
        date: document.getElementById("record-date").value,
        meal: document.getElementById("meal-type").value,
        students: document.getElementById("students").value,
        adults: document.getElementById("adults").value,
        manager: document.getElementById("manager").value,
        sections: {}
      };
      
      document.querySelectorAll("table[data-section]").forEach(tbl => {
        const sec = tbl.dataset.section;
        const rows = [];
        tbl.querySelectorAll("tbody tr").forEach(tr => {
          const vals = Array.from(tr.querySelectorAll("input")).map(i => i.value);
          const calcs = Array.from(tr.querySelectorAll("td:not(:has(input)):not(:has(button))")).map(td => td.textContent);
          rows.push({inputs: vals, calcs: calcs});
        });
        data.sections[sec] = rows;
      });
      
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadData(){
      const key = getKey();
      const saved = localStorage.getItem(key);
      if (!saved) return;
      
      const data = JSON.parse(saved);
      document.getElementById("students").value = data.students || "";
      document.getElementById("adults").value = data.adults || "";
      document.getElementById("manager").value = data.manager || "";
      
      Object.keys(data.sections || {}).forEach(sec => {
        data.sections[sec].forEach(rowData => {
          addRow(sec);
          const table = document.querySelector(`table[data-section="${sec}"]`);
          const lastRow = table.querySelector("tbody tr:last-child");
          const inputs = lastRow.querySelectorAll("input");
          rowData.inputs.forEach((val, i) => {
            if (inputs[i]) inputs[i].value = val;
          });
          if (inputs[0]) calc(inputs[0]);
        });
      });
    }

    function getKey(){
      return `${localStorage.getItem("currentSchool")}:${document.getElementById("record-date").value}:${document.getElementById("meal-type").value}`;
    }

    function lockRecord(){
      if (confirm("Lock this record?")) {
        document.getElementById("status").textContent = "LOCKED";
        localStorage.setItem(getKey() + ":status", "locked");
        alert("Record locked!");
      }
    }

    function goBack(){
      window.location.href = "index.html";
    }

    // PDF GENERATION
    function generatePDF(){
      const doc = new jsPDF('p', 'mm', 'letter');
      
      // Header
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text('AUHSD FOOD SERVICES', 105, 15, {align: 'center'});
      
      doc.setFontSize(16);
      doc.setTextColor(0);
      doc.setFont(undefined, 'bold');
      doc.text('DAILY PRODUCTION RECORD', 105, 25, {align: 'center'});
      
      // Info Box
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      const school = document.getElementById("school-name").textContent;
      const date = document.getElementById("record-date").value;
      const meal = document.getElementById("meal-type").value;
      const students = document.getElementById("students").value;
      const adults = document.getElementById("adults").value;
      const manager = document.getElementById("manager").value;
      const status = document.getElementById("status").textContent;
      
      doc.rect(15, 30, 180, 20);
      doc.text(`School: ${school}`, 20, 36);
      doc.text(`Date: ${date}`, 110, 36);
      doc.text(`Meal: ${meal}`, 20, 41);
      doc.text(`Students: ${students}`, 110, 41);
      doc.text(`Manager: ${manager}`, 20, 46);
      doc.text(`Status: ${status}`, 110, 46);
      
      let yPos = 55;
      
      // Sections
      document.querySelectorAll("table[data-section]").forEach(tbl => {
        const section = tbl.dataset.section;
        const rows = tbl.querySelectorAll("tbody tr");
        
        if (rows.length === 0) return;
        
        // Section Header
        doc.setFillColor(0, 74, 153);
        doc.rect(15, yPos, 180, 6, 'F');
        doc.setTextColor(255);
        doc.setFont(undefined, 'bold');
        doc.text(section, 17, yPos + 4);
        yPos += 8;
        
        // Table
        const tableData = [];
        const headers = [];
        
        tbl.querySelectorAll("thead th").forEach((th, i) => {
          if (i < tbl.querySelectorAll("thead th").length - 1) { // Skip Delete column
            headers.push(th.textContent);
          }
        });
        
        rows.forEach(row => {
          const rowData = [];
          row.querySelectorAll("td").forEach((td, i) => {
            if (i < row.querySelectorAll("td").length - 1) { // Skip Delete column
              const input = td.querySelector("input");
              rowData.push(input ? input.value : td.textContent);
            }
          });
          tableData.push(rowData);
        });
        
        doc.autoTable({
          head: [headers],
          body: tableData,
          startY: yPos,
          margin: {left: 15, right: 15},
          styles: {fontSize: 7, cellPadding: 1},
          headStyles: {fillColor: [224, 224, 224], textColor: 0},
          theme: 'grid'
        });
        
        yPos = doc.lastAutoTable.finalY + 5;
        
        if (yPos > 240) yPos = 240; // Prevent overflow
      });
      
      // Signature
      if (yPos < 250) {
        doc.setTextColor(0);
        doc.setFont(undefined, 'normal');
        doc.text('Prepared by: _____________________', 20, yPos + 10);
        doc.text('Date: __________', 110, yPos + 10);
      }
      
      // Save
      const filename = `${school.replace(/\s+/g, '_')}_${meal}_${date}.pdf`;
      doc.save(filename);
    }

    init();
  </script>
</body>
</html>

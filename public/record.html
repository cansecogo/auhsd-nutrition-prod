<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AUHSD Production Record</title>

  <!-- =========================================================
       CSS
       - SCREEN: bigger + color
       - PRINT : compact 1-page
       ========================================================= -->
  <style>
    :root{
      --brand:#0b2d5c;
      --brand2:#004a99;
      --ink:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --bg:#f4f7fb;
      --line:#d6dee8;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }

    /* ---------- SCREEN ---------- */
    @media screen{
      body{
        font-family: "Segoe UI", Arial, Helvetica, sans-serif;
        padding:20px;
        background:var(--bg);
        color:var(--ink);
        font-size:14px;
        line-height:1.35;
      }

      .page{
        max-width:1400px;
        margin:0 auto;
        background:var(--card);
        border-radius:14px;
        box-shadow:0 10px 30px rgba(2, 8, 23, 0.10);
        padding:18px 18px 22px;
      }

      .header-title{
        text-align:center;
        margin-bottom:10px;
        text-transform:uppercase;
        letter-spacing:1px;
      }
      .header-title .small{
        font-size:10px;
        color:var(--muted);
        margin-bottom:2px;
        font-weight:700;
      }
      .header-title .big{
        font-size:18px;
        font-weight:900;
        color:var(--brand);
      }

      .hs-header{
        display:none;
        border:2px solid var(--brand);
        background:#eef5ff;
        padding:10px;
        margin-bottom:10px;
        border-radius:12px;
        font-size:13px;
      }
      .hs-header-grid{
        display:grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap:12px;
      }
      .hs-label{ font-weight:900; color:var(--brand); margin-right:6px; }

      .info-grid{
        display:grid;
        grid-template-columns: repeat(3, 1fr);
        gap:12px;
        margin-bottom:14px;
        font-size:13px;
      }
      .info-item{
        border:1px solid var(--line);
        padding:10px 12px;
        background:#f8fbff;
        border-radius:12px;
      }
      .info-label{
        font-weight:900;
        display:block;
        font-size:11px;
        text-transform:uppercase;
        margin-bottom:6px;
        color:var(--muted);
        letter-spacing:0.6px;
      }
      .info-value{
        font-weight:900;
        font-size:14px;
      }

      input, select{
        width:100%;
        padding:8px 10px;
        border:1px solid var(--line);
        border-radius:10px;
        font-size:13px;
        font-family:inherit;
        background:#fff;
      }
      input:focus, select:focus{
        outline:2px solid rgba(0,74,153,0.25);
        border-color:rgba(0,74,153,0.55);
      }

      .section{ margin-bottom:14px; }
      .section-header{
        background:linear-gradient(90deg, var(--brand), var(--brand2));
        color:#fff;
        padding:8px 10px;
        font-weight:900;
        font-size:13px;
        text-transform:uppercase;
        display:flex;
        justify-content:space-between;
        align-items:center;
        border-radius:12px;
      }
      .section-add{
        background:#fff;
        color:var(--brand);
        border:none;
        padding:6px 10px;
        font-size:12px;
        font-weight:900;
        cursor:pointer;
        border-radius:10px;
      }
      .section-add:active{ transform:translateY(1px); }

      table{
        width:100%;
        border-collapse:collapse;
        font-size:12px;
        margin-top:6px;
        background:#fff;
      }
      th, td{
        border:1px solid #000;
        padding:6px 6px;
        text-align:center;
      }
      th{
        background:#eaf2ff;
        font-weight:900;
        font-size:12px;
        color:var(--brand);
      }
      td input{
        width:100%;
        padding:6px 6px;
        border:1px solid var(--line);
        border-radius:8px;
        font-size:12px;
        text-align:center;
      }
      .item-col{ text-align:left !important; width:28%; }
      .item-col input{ text-align:left; font-weight:800; }

      .del-btn{
        background:#d00;
        color:#fff;
        border:none;
        padding:4px 8px;
        font-size:12px;
        cursor:pointer;
        border-radius:8px;
        font-weight:900;
      }

      .total-row{
        background:#f1f5f9;
        font-weight:900;
      }

      .signature{
        margin-top:16px;
        display:grid;
        grid-template-columns: 2fr 1fr;
        gap:16px;
        font-size:13px;
      }
      .sig-line{ border-bottom:2px solid #000; margin-top:18px; }
      .sig-label{ font-weight:900; font-size:12px; }

      .buttons{
        margin-top:16px;
        display:flex;
        gap:10px;
        flex-wrap:wrap;
      }
      .btn{
        padding:12px 14px;
        border:none;
        border-radius:12px;
        cursor:pointer;
        font-weight:900;
        font-size:13px;
      }
      .btn-primary{ background:#0d6efd; color:#fff; }
      .btn-success{ background:#198754; color:#fff; }
      .btn-warning{ background:#f0b429; color:#000; }
      .btn-secondary{ background:#6c757d; color:#fff; }
    }

    /* ---------- PRINT ---------- */
    @media print{
      @page { size: letter; margin: 0.25in; }

      body{
        font-family: Arial, Helvetica, sans-serif;
        padding:0.25in;
        background:#fff;
        color:#000;
        font-size:9px;
        line-height:1.25;
      }
      .page{
        max-width:100%;
        margin:0;
        padding:0;
        background:#fff;
        box-shadow:none;
        border-radius:0;
      }
      .header-title .small{ color:#000; }
      .header-title .big{ color:#000; font-size:12px; }
      .hs-header{ display:none !important; }

      .info-grid{
        display:grid;
        grid-template-columns: repeat(3, 1fr);
        gap:6px;
        margin-bottom:8px;
        font-size:9px;
      }
      .info-item{
        border:1px solid #ccc;
        padding:4px 6px;
        background:#f9f9f9;
        border-radius:0;
      }
      .info-label{
        font-weight:bold;
        font-size:8px;
        margin-bottom:2px;
        color:#000;
      }
      .info-value{
        font-weight:bold;
        font-size:9px;
      }
      input, select{
        width:100%;
        padding:0;
        border:none !important;
        background:transparent !important;
        font-size:9px;
        font-family:inherit;
      }

      .section{
        margin-bottom:8px;
        page-break-inside:avoid;
      }
      .section-header{
        background:#000 !important;
        color:#fff !important;
        padding:4px 8px;
        font-weight:900;
        font-size:9px;
        border-radius:0;
      }
      table{
        width:100%;
        border-collapse:collapse;
        font-size:8px;
        margin-top:2px;
      }
      th, td{
        border:1px solid #000;
        padding:2px 3px;
        text-align:center;
      }
      th{
        background:#e0e0e0 !important;
        font-weight:900;
        font-size:8px;
        color:#000 !important;
      }
      td input{
        padding:0;
        border:none;
        font-size:8px;
      }
      .total-row{
        background:#f0f0f0 !important;
        font-weight:bold;
      }

      .signature{
        margin-top:8px;
        display:grid;
        grid-template-columns: 2fr 1fr;
        gap:12px;
        font-size:9px;
        page-break-inside:avoid;
      }
      .sig-line{
        border-bottom:1px solid #000;
        margin-top:14px;
      }
      .sig-label{
        font-weight:bold;
        font-size:8px;
      }

      .buttons, .section-add, .del-btn{
        display:none !important;
      }
    }

    /* ---------- MODAL ---------- */
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.7);
      z-index:999;
      overflow-y:auto;
    }
    .modal-content{
      background:#fff;
      margin:40px auto;
      padding:24px;
      max-width:900px;
      border-radius:8px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      border-bottom:2px solid #ddd;
      padding-bottom:12px;
    }
    .close-modal{
      font-size:24px;
      cursor:pointer;
      color:#999;
    }
    .record-card{
      border:1px solid #ddd;
      padding:12px;
      margin-bottom:8px;
      cursor:pointer;
      border-radius:6px;
    }
    .record-card:hover{
      background:#f0f0f0;
    }
    .record-date{
      font-weight:bold;
      font-size:14px;
    }
    .record-meta{
      color:#666;
      font-size:11px;
      margin-top:4px;
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- Header Title -->
    <div class="header-title">
      <div class="small">AUHSD FOOD SERVICES</div>
      <div class="big">DAILY PRODUCTION RECORD</div>
    </div>

    <!-- HS/JHS Only Header -->
    <div class="hs-header" id="hs-header">
      <div class="hs-header-grid">
        <div>
          <span class="hs-label">School:</span>
          <span id="hs-school-name">—</span>
        </div>
        <div>
          <span class="hs-label">Grades:</span>
          <span id="hs-grades">9 to 12</span>
        </div>
        <div>
          <span class="hs-label">Total Meal Count:</span>
          <span id="hs-meal-count">0</span>
        </div>
      </div>
    </div>

    <!-- Info Grid -->
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">School</span>
        <div class="info-value" id="disp-school">—</div>
      </div>
      <div class="info-item">
        <span class="info-label">Type</span>
        <div class="info-value" id="disp-type">—</div>
      </div>
      <div class="info-item">
        <span class="info-label">Meal</span>
        <select id="meal-picker">
          <option>Breakfast</option>
          <option>Lunch</option>
          <option>Salad Bar</option>
        </select>
      </div>

      <div class="info-item">
        <span class="info-label">Date</span>
        <input type="date" id="prod-date" />
      </div>
      <div class="info-item">
        <span class="info-label">School Year</span>
        <div class="info-value" id="disp-year">—</div>
      </div>
      <div class="info-item">
        <span class="info-label">Status</span>
        <div class="info-value" id="disp-status">DRAFT</div>
      </div>

      <div class="info-item">
        <span class="info-label">Students Served</span>
        <input type="number" id="students-served" placeholder="0" />
      </div>
      <div class="info-item">
        <span class="info-label">Adult Meals</span>
        <input type="number" id="adult-meals" placeholder="0" />
      </div>
      <div class="info-item">
        <span class="info-label">Manager/Clerk Name</span>
        <input type="text" id="mgr-name" placeholder="Name" />
      </div>
    </div>

    <!-- Sections Container -->
    <div id="sections-container"></div>

    <!-- Signature -->
    <div class="signature">
      <div>
        <div class="sig-label">Prepared by (Print Name): <span id="sig-name">____________________</span></div>
        <div class="sig-label">Signature:</div>
        <div class="sig-line"></div>
      </div>
      <div>
        <div class="sig-label">Date:</div>
        <div class="sig-line"></div>
      </div>
    </div>

    <!-- Buttons (hidden on print) -->
    <div class="buttons">
      <button id="btn-lock" class="btn btn-warning" type="button">Complete & Lock</button>
      <button id="btn-unlock" class="btn btn-success" type="button" style="display:none;">Unlock</button>
      <button id="btn-print" class="btn btn-primary" type="button">Print</button>
      <button id="btn-dashboard" class="btn btn-secondary" type="button">View Past Records</button>
      <button id="btn-logout" class="btn btn-secondary" type="button">Switch School</button>
    </div>
  </div>

  <!-- Dashboard Modal -->
  <div id="dashboard-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Past Records (Last 3 Weeks)</h3>
        <span class="close-modal" id="close-modal">&times;</span>
      </div>
      <div id="record-list"></div>
    </div>
  </div>

  <!-- =========================================================
       JAVASCRIPT
       ========================================================= -->
  <script>
    const $ = (s) => document.querySelector(s);
    let schoolType = "";
    let currentMeal = "Breakfast";
    let isLocked = false;

    const SECTIONS = {
      "Elementary": {
        "Breakfast": [
          "GRAIN (M/MA counted as Grains)",
          "FRUIT",
          "CONDIMENTS",
          "MILK & MILK SUBSTITUTES (8OZ)",
          "Special Diets (from DFC)"
        ],
        "Lunch": [
          "GRAIN & MEAT/MEAT ALT",
          "FRUIT (1/2 CUP) & VEGETABLE (1/2 CUP)",
          "GRAIN-BASED DESSERT",
          "CONDIMENTS",
          "MILK & MILK SUBSTITUTES (8OZ)",
          "Special Diets (from DFC)"
        ]
      },
      "High School": {
        "Breakfast": ["GRAINS", "FRUIT", "MILK", "EXTRA FOOD CONDIMENTS"],
        "Lunch": ["ENTREE", "VEGETABLE", "FRUIT", "MILK", "EXTRA FOOD CONDIMENTS"],
        "Salad Bar": ["ENTREE", "MILK", "VEGETABLE", "FRUIT", "EXTRAS", "Condiments (Pre-packaged)"]
      }
    };

    function makeSafeId(sec){
      return String(sec).toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
    }

    function init(){
      const school = localStorage.getItem("currentSchool") || "—";
      schoolType = localStorage.getItem("schoolType") || "Elementary";

      $("#disp-school").textContent = school;
      $("#disp-type").textContent = schoolType;

      // default date today
      const today = new Date();
      $("#prod-date").valueAsDate = today;

      if (schoolType === "High School") {
        $("#hs-header").style.display = "block";
        $("#hs-school-name").textContent = school;
      } else {
        $("#hs-header").style.display = "none";
      }

      currentMeal = $("#meal-picker").value;
      updateYear();
      renderSections();
      loadData();
    }

    function updateYear(){
      const v = $("#prod-date").value;
      if (!v) { $("#disp-year").textContent = "—"; return; }
      const d = new Date(v);
      const y = d.getFullYear();
      const m = d.getMonth(); // 0=Jan ... 6=Jul
      // School year starts in July (month 6)
      $("#disp-year").textContent = (m >= 6) ? `${y} - ${y+1}` : `${y-1} - ${y}`;
    }

    function getHSHeader(){
      return `<thead><tr>
        <th class="item-col">Menu Item</th>
        <th>Recipe #</th>
        <th>Cook Temp</th>
        <th>Serve Temp</th>
        <th>Prev</th>
        <th>New</th>
        <th>Total</th>
        <th>Served</th>
        <th>Discard</th>
        <th>Future</th>
        <th>End Temp</th>
        <th>Del</th>
      </tr></thead>`;
    }

    function getElemHeader(){
      return `<thead><tr>
        <th class="item-col">Menu Item</th>
        <th>Prepared</th>
        <th>Leftover</th>
        <th>Discard</th>
        <th>Served</th>
        <th>Temp 1</th>
        <th>Temp 2</th>
        <th>Temp 3</th>
        <th>Del</th>
      </tr></thead>`;
    }

    // Render sections (no inline onclick so it works in stricter environments)
    function renderSections(){
      const container = $("#sections-container");
      container.innerHTML = "";

      const sections = SECTIONS[schoolType]?.[currentMeal] || [];

      sections.forEach(sec => {
        const div = document.createElement("div");
        div.className = "section";

        const header = document.createElement("div");
        header.className = "section-header";

        const title = document.createElement("span");
        title.textContent = sec;

        const addBtn = document.createElement("button");
        addBtn.className = "section-add";
        addBtn.type = "button";
        addBtn.textContent = "+ Add";
        addBtn.addEventListener("click", () => addRow(sec));

        header.appendChild(title);
        header.appendChild(addBtn);

        const table = document.createElement("table");
        table.dataset.section = sec;
        table.innerHTML = (schoolType === "High School") ? getHSHeader() : getElemHeader();

        const tbody = document.createElement("tbody");
        tbody.className = "tbody";
        table.appendChild(tbody);

        // Total row (always)
        const safe = makeSafeId(sec);
        const totalRow = document.createElement("tr");
        totalRow.className = "total-row";
        if (schoolType === "High School") {
          totalRow.innerHTML = `
            <td colspan="4"><strong>TOTAL</strong></td>
            <td id="tot-${safe}-prev">0</td>
            <td id="tot-${safe}-new">0</td>
            <td id="tot-${safe}-total">0</td>
            <td id="tot-${safe}-serv">0</td>
            <td id="tot-${safe}-disc">0</td>
            <td id="tot-${safe}-fut">0</td>
            <td colspan="2"></td>
          `;
        } else {
          totalRow.innerHTML = `
            <td><strong>Total Used</strong></td>
            <td id="tot-${safe}-prep">0</td>
            <td id="tot-${safe}-left">0</td>
            <td id="tot-${safe}-disc">0</td>
            <td id="tot-${safe}-serv">0</td>
            <td colspan="4"></td>
          `;
        }
        tbody.appendChild(totalRow);

        div.appendChild(header);
        div.appendChild(table);
        container.appendChild(div);
      });
    }

    function addRow(sec){
      if (isLocked) return alert("Cannot add when locked.");

      const table = document.querySelector(`table[data-section="${CSS.escape(sec)}"]`);
      if (!table) return;
      const tbody = table.querySelector(".tbody");
      if (!tbody) return;

      const totalRow = tbody.querySelector("tr.total-row");
      const row = document.createElement("tr");
      tbody.insertBefore(row, totalRow);

      if (schoolType === "High School") {
        row.innerHTML = `
          <td class="item-col"><input type="text" class="item" /></td>
          <td><input type="text" class="recipe" style="background:#f0f0f0;" readonly /></td>
          <td><input type="text" class="cook" /></td>
          <td><input type="text" class="serve" /></td>
          <td><input type="number" class="prev" value="0" /></td>
          <td><input type="number" class="new" value="0" /></td>
          <td class="total">0</td>
          <td><input type="number" class="serv" value="0" /></td>
          <td><input type="number" class="disc" value="0" /></td>
          <td class="fut">0</td>
          <td><input type="text" class="end" /></td>
          <td><button type="button" class="del-btn">X</button></td>
        `;
      } else {
        row.innerHTML = `
          <td class="item-col"><input type="text" class="item" /></td>
          <td><input type="number" class="prep" value="0" /></td>
          <td><input type="number" class="left" value="0" /></td>
          <td><input type="number" class="disc" value="0" /></td>
          <td class="serv">0</td>
          <td><input type="text" class="t1" /></td>
          <td><input type="text" class="t2" /></td>
          <td><input type="text" class="t3" /></td>
          <td><button type="button" class="del-btn">X</button></td>
        `;
      }

      wireRow(row);
      updateTotals();
      save();
    }

    function wireRow(row){
      const delBtn = row.querySelector(".del-btn");
      if (delBtn){
        delBtn.addEventListener("click", () => delRow(delBtn));
      }

      if (schoolType === "High School"){
        // math inputs
        row.querySelectorAll(".prev, .new, .serv, .disc").forEach(inp => {
          inp.addEventListener("input", () => { calcHS(inp); save(); });
        });
        // other inputs
        row.querySelectorAll("input:not(.prev):not(.new):not(.serv):not(.disc)").forEach(inp => {
          inp.addEventListener("input", save);
        });
      } else {
        row.querySelectorAll(".prep, .left, .disc").forEach(inp => {
          inp.addEventListener("input", () => { calcElem(inp); save(); });
        });
        row.querySelectorAll("input:not(.prep):not(.left):not(.disc)").forEach(inp => {
          inp.addEventListener("input", save);
        });
      }
    }

    function delRow(btn){
      if (isLocked) return alert("Cannot delete when locked.");
      const tr = btn.closest("tr");
      if (!tr) return;
      if (confirm("Delete this item?")) {
        tr.remove();
        updateTotals();
        save();
      }
    }

    function calcHS(el){
      const row = el.closest("tr");
      if (!row) return;
      const prev = parseFloat(row.querySelector(".prev")?.value) || 0;
      const newP = parseFloat(row.querySelector(".new")?.value) || 0;
      const total = prev + newP;
      const totalCell = row.querySelector(".total");
      if (totalCell) totalCell.textContent = total;

      const serv = parseFloat(row.querySelector(".serv")?.value) || 0;
      const disc = parseFloat(row.querySelector(".disc")?.value) || 0;
      const futCell = row.querySelector(".fut");
      if (futCell) futCell.textContent = total - serv - disc;

      updateTotals();
    }

    function calcElem(el){
      const row = el.closest("tr");
      if (!row) return;
      const prep = parseFloat(row.querySelector(".prep")?.value) || 0;
      const left = parseFloat(row.querySelector(".left")?.value) || 0;
      const disc = parseFloat(row.querySelector(".disc")?.value) || 0;
      const servCell = row.querySelector(".serv");
      if (servCell) servCell.textContent = prep - left - disc;

      updateTotals();
    }

    function updateTotals(){
      document.querySelectorAll("table[data-section]").forEach(tbl => {
        const sec = tbl.dataset.section;
        const safe = makeSafeId(sec);
        const tbody = tbl.querySelector("tbody");
        if (!tbody) return;

        if (schoolType === "High School"){
          let totPrev=0, totNew=0, totServ=0, totDisc=0;
          tbody.querySelectorAll("tr").forEach(tr => {
            if (tr.classList.contains("total-row")) return;
            totPrev += parseFloat(tr.querySelector(".prev")?.value) || 0;
            totNew  += parseFloat(tr.querySelector(".new")?.value) || 0;
            totServ += parseFloat(tr.querySelector(".serv")?.value) || 0;
            totDisc += parseFloat(tr.querySelector(".disc")?.value) || 0;
          });
          const totTotal = totPrev + totNew;
          const totFut = totTotal - totServ - totDisc;

          const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
          set(`tot-${safe}-prev`,  totPrev);
          set(`tot-${safe}-new`,   totNew);
          set(`tot-${safe}-total`, totTotal);
          set(`tot-${safe}-serv`,  totServ);
          set(`tot-${safe}-disc`,  totDisc);
          set(`tot-${safe}-fut`,   totFut);
        } else {
          let totPrep=0, totLeft=0, totDisc=0;
          tbody.querySelectorAll("tr").forEach(tr => {
            if (tr.classList.contains("total-row")) return;
            totPrep += parseFloat(tr.querySelector(".prep")?.value) || 0;
            totLeft += parseFloat(tr.querySelector(".left")?.value) || 0;
            totDisc += parseFloat(tr.querySelector(".disc")?.value) || 0;
          });
          const totServ = totPrep - totLeft - totDisc;

          const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
          set(`tot-${safe}-prep`, totPrep);
          set(`tot-${safe}-left`, totLeft);
          set(`tot-${safe}-disc`, totDisc);
          set(`tot-${safe}-serv`, totServ);
        }
      });

      // HS meal count (sum of Served inputs)
      if (schoolType === "High School"){
        let total = 0;
        document.querySelectorAll(".serv").forEach(inp => {
          if (inp && inp.tagName === "INPUT") total += parseFloat(inp.value) || 0;
        });
        $("#hs-meal-count").textContent = total;
      }
    }

    function getKey(){
      const school = localStorage.getItem("currentSchool") || "—";
      return `${school}:${$("#prod-date").value}:${$("#meal-picker").value}`;
    }

    function save(){
      const key = getKey();
      const data = {
        students: $("#students-served").value,
        adults: $("#adult-meals").value,
        mgr: $("#mgr-name").value,
        sections: {}
      };

      document.querySelectorAll("table[data-section]").forEach(tbl => {
        const sec = tbl.dataset.section;
        const rows = [];
        const tbody = tbl.querySelector("tbody");
        if (!tbody) return;

        tbody.querySelectorAll("tr").forEach(tr => {
          if (tr.classList.contains("total-row")) return;
          const vals = Array.from(tr.querySelectorAll("input")).map(i => i.value);
          rows.push(vals);
        });

        data.sections[sec] = rows;
      });

      localStorage.setItem(key, JSON.stringify(data));
      localStorage.setItem(key + ":status", isLocked ? "locked" : "draft");
    }

    function loadData(){
      const key = getKey();
      const saved = localStorage.getItem(key);
      if (!saved) { updateTotals(); return; }

      const data = JSON.parse(saved);
      $("#students-served").value = data.students || "";
      $("#adult-meals").value = data.adults || "";
      $("#mgr-name").value = data.mgr || "";
      $("#sig-name").textContent = data.mgr || "____________________";

      // fill rows
      Object.keys(data.sections || {}).forEach(sec => {
        const rows = data.sections[sec] || [];
        rows.forEach(rowData => {
          addRow(sec);
          const table = document.querySelector(`table[data-section="${CSS.escape(sec)}"]`);
          const tbody = table?.querySelector("tbody");
          if (!tbody) return;

          // last row is just before total row
          const allRows = Array.from(tbody.querySelectorAll("tr")).filter(r => !r.classList.contains("total-row"));
          const lastRow = allRows[allRows.length - 1];
          if (!lastRow) return;

          const inputs = lastRow.querySelectorAll("input");
          rowData.forEach((val, i) => { if (inputs[i]) inputs[i].value = val; });

          // recalc
          if (schoolType === "High School") {
            const pivot = lastRow.querySelector(".prev") || lastRow.querySelector(".new") || lastRow.querySelector(".serv") || lastRow.querySelector(".disc");
            if (pivot) calcHS(pivot);
          } else {
            const pivot = lastRow.querySelector(".prep") || lastRow.querySelector(".left") || lastRow.querySelector(".disc");
            if (pivot) calcElem(pivot);
          }
        });
      });

      const status = localStorage.getItem(key + ":status");
      if (status === "locked") lock(true);

      updateTotals();
    }

    function lock(isFromLoad=false){
      isLocked = true;
      document.querySelectorAll("input, select").forEach(el => el.disabled = true);
      document.querySelectorAll(".section-add, .del-btn").forEach(b => b.style.display = "none");
      $("#btn-lock").style.display = "none";
      $("#disp-status").textContent = "LOCKED";

      const today = new Date().toDateString();
      const recDate = new Date($("#prod-date").value).toDateString();
      if (today === recDate) $("#btn-unlock").style.display = "inline-block";

      if (!isFromLoad) save();
    }

    function unlock(){
      if (!confirm("Unlock this record?")) return;
      isLocked = false;
      document.querySelectorAll("input, select").forEach(el => el.disabled = false);
      document.querySelectorAll(".section-add, .del-btn").forEach(b => b.style.display = "inline-block");
      $("#btn-lock").style.display = "inline-block";
      $("#btn-unlock").style.display = "none";
      $("#disp-status").textContent = "DRAFT";
      localStorage.setItem(getKey() + ":status", "draft");
      save();
    }

    function showDashboard(){
      const modal = $("#dashboard-modal");
      const list = $("#record-list");
      list.innerHTML = "";

      const school = localStorage.getItem("currentSchool");
      const today = new Date();
      const threeWeeks = new Date(today.getTime() - 21 * 24 * 60 * 60 * 1000);

      const records = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key) continue;
        if (key.startsWith((school || "") + ":") && !key.includes(":status")) {
          const parts = key.split(":");
          const date = new Date(parts[1]);
          if (!isNaN(date) && date >= threeWeeks) {
            records.push({
              key,
              date,
              meal: parts[2] || "",
              status: localStorage.getItem(key + ":status") || "draft"
            });
          }
        }
      }

      records.sort((a, b) => b.date - a.date);

      if (records.length === 0) {
        list.innerHTML = "<p>No records found.</p>";
      } else {
        records.forEach(rec => {
          const card = document.createElement("div");
          card.className = "record-card";
          card.innerHTML = `
            <div class="record-date">${rec.date.toLocaleDateString()} - ${rec.meal}</div>
            <div class="record-meta">Status: ${String(rec.status).toUpperCase()}</div>
          `;
          card.addEventListener("click", () => {
            const parts = rec.key.split(":");
            $("#prod-date").value = parts[1];
            $("#meal-picker").value = parts[2];
            currentMeal = $("#meal-picker").value;
            updateYear();
            renderSections();
            loadData();
            modal.style.display = "none";
          });
          list.appendChild(card);
        });
      }

      modal.style.display = "block";
    }

    // ---------------- Events ----------------
    $("#btn-lock").addEventListener("click", () => {
      if (!$("#prod-date").value) return alert("Select date");
      if (!$("#mgr-name").value.trim()) return alert("Enter manager name");
      if (!confirm("Lock this record?")) return;
      lock(false);
    });

    $("#btn-unlock").addEventListener("click", unlock);
    $("#btn-print").addEventListener("click", () => window.print());
    $("#btn-dashboard").addEventListener("click", showDashboard);

    $("#btn-logout").addEventListener("click", () => {
      localStorage.removeItem("currentSchool");
      localStorage.removeItem("schoolType");
      location.href = "index.html";
    });

    $("#close-modal").addEventListener("click", () => $("#dashboard-modal").style.display = "none");

    $("#prod-date").addEventListener("change", () => {
      updateYear();
      renderSections();
      loadData();
    });

    $("#meal-picker").addEventListener("change", () => {
      currentMeal = $("#meal-picker").value;
      renderSections();
      loadData();
    });

    $("#students-served").addEventListener("input", save);
    $("#adult-meals").addEventListener("input", save);
    $("#mgr-name").addEventListener("input", () => {
      $("#sig-name").textContent = $("#mgr-name").value || "____________________";
      save();
    });

    // Init
    init();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AUHSD Production Record</title>

  <!-- =========================================================
       CSS (STYLES) - everything that controls how it looks
       ========================================================= -->
  <style>
    :root{
      --brand:#0b2d5c;
      --brand-2:#004a99;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e8eef6;
      --card:#f7f9fb;
      --shadow: 0 10px 25px rgba(2, 6, 23, 0.08);
      --radius: 14px;
    }

    *{ box-sizing:border-box; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      margin:0;
      padding:22px;
      background:#f4f7f6;
      color:var(--ink);
    }

    .paper{
      background:#fff;
      padding:26px 28px 28px;
      max-width:1200px;
      margin:auto;
      box-shadow: var(--shadow);
      border-top:10px solid var(--brand-2);
      border-radius: var(--radius);
    }

    /* ===== Header layout ===== */
    .district-name{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin:0 0 8px 0;
      font-weight:700;
    }

    .header-section{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:18px;
      padding-bottom:16px;
      border-bottom:2px solid var(--line);
      margin-bottom:18px;
    }

    .header-left{ flex:1; min-width:520px; }
    .header-right{ display:flex; gap:14px; align-items:flex-start; }

    .title-row{
      display:flex;
      align-items:baseline;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      color:var(--brand);
      font-size:28px;
      letter-spacing:.2px;
      font-weight:900;
    }

    .status-badge{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .status-draft{ background:#e9f2ff; color:#0b4aa2; border-color:#cfe2ff; }
    .status-locked{ background:#fff3cd; color:#8a6d3b; border-color:#ffe69c; }

    .sub-row{
      display:flex;
      gap:14px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .meta-item{
      background:var(--card);
      border:1px solid #e6ebf0;
      border-radius:12px;
      padding:10px 12px;
      min-width:210px;
    }

    .meta-label{
      font-size:11px;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:800;
      margin-bottom:6px;
    }
    .meta-value{
      font-size:15px;
      font-weight:800;
      color:var(--ink);
      line-height:1.2;
    }

    /* Inputs used inside meta cards */
    input, select{
      font:inherit;
      padding:8px 10px;
      border:1px solid #cfd8e3;
      border-radius:10px;
      width:100%;
      background:#fff;
      outline:none;
    }
    input:focus, select:focus{ border-color:#7aa6e6; box-shadow: 0 0 0 3px rgba(122,166,230,.25); }

    .date-box, .saved-box{ width:220px; }
    .saved-value{ font-weight:800; color:var(--ink); }

    /* ===== Table ===== */
    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td{ border:1px solid #2b2b2b; padding:8px; text-align:center; }
    th{ background:var(--brand-2); color:white; font-weight:800; }
    .item-input{ width:100%; max-width:420px; background:#fffde7; font-weight:800; }
    input[type="number"]{ width:92px; }

    /* ===== Buttons ===== */
    .btn-row{ margin-top:26px; display:flex; gap:14px; }
    .btn{
      padding:12px 18px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      font-size:14px;
      transition:.15s ease;
    }
    .btn:hover{ transform: translateY(-1px); opacity:.95; }
    .add{ background:#0d6efd; color:white; }
    .lock{ background:#e0a800; color:white; }
    .print{ background:#198754; color:white; }
    .logout{ background:#6c757d; color:white; }

    /* ===== Signature section ===== */
    .signature-section{
      margin-top:42px;
      display:flex;
      gap:30px;
      page-break-inside:avoid;
    }
    .sig-box{ flex:1; }
    .sig-label{ font-weight:900; font-size:14px; }
    .sig-line{
      border-bottom:2px solid #000;
      margin-top:30px;
      height:1px;
    }

    /* ===== Locked mode styles ===== */
    input:disabled, select:disabled{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      color:#4b5563;
      cursor:not-allowed;
    }

    /* =========================================================
       PRINT STYLES - what it looks like on paper
       ========================================================= */
    @media print{
      /* hide buttons */
      .btn-row, button{ display:none !important; }

      body{ background:#fff; padding:0; margin:0; }
      .paper{
        box-shadow:none;
        border:none;
        border-top:none;
        border-radius:0;
        padding:16px 16px 0;
        width:100%;
        max-width:100%;
      }

      /* make inputs look like text */
      input, select{
        border:none !important;
        background:transparent !important;
        box-shadow:none !important;
        padding:0 !important;
      }

      /* hide placeholder text */
      input::placeholder{ color:transparent !important; opacity:0 !important; }

      /* keep first column wider */
      th:first-child, td:first-child{ width:40% !important; }
      input{ font-size:11px !important; }
      .item-input{ width:100% !important; max-width:none !important; }
    }
  </style>
</head>

<body>
  <div class="paper">

    <!-- =========================================================
         HEADER (TOP OF FORM)
         ========================================================= -->
    <div class="district-name">AUHSD Food Services</div>

    <div class="header-section">
      <div class="header-left">
        <div class="title-row">
          <h1 id="title">Daily Production Record</h1>
          <span id="disp-status" class="status-badge status-draft">DRAFT</span>
        </div>

        <!-- Row 1: Site + Type + Meal -->
        <div class="sub-row">
          <div class="meta-item">
            <div class="meta-label">Site</div>
            <div class="meta-value" id="disp-school">—</div>
          </div>

          <div class="meta-item">
            <div class="meta-label">Type</div>
            <div class="meta-value" id="disp-type">—</div>
          </div>

          <div class="meta-item">
            <div class="meta-label">Meal</div>
            <select id="meal-picker">
              <option value="Breakfast">Breakfast</option>
              <option value="Lunch">Lunch</option>
            </select>
          </div>
        </div>

        <!-- Row 2: School Year + Student Served + Adult Meals + Manager/Clerk -->
        <div class="sub-row">
          <div class="meta-item">
            <div class="meta-label">School Year</div>
            <div class="meta-value" id="disp-schoolyear">—</div>
          </div>

          <div class="meta-item">
            <div class="meta-label">Students Served (Computer Total)</div>
            <input id="students-served" type="number" min="0" step="1" placeholder="0" />
          </div>

          <div class="meta-item">
            <div class="meta-label">Adult/Earned Meals</div>
            <input id="adult-meals" type="number" min="0" step="1" placeholder="0" />
          </div>

          <div class="meta-item" style="min-width:260px;">
            <div class="meta-label">Manager/Clerk Name (Printed)</div>
            <input id="mgr-name" type="text" placeholder="Type name..." />
          </div>
        </div>
      </div>

      <div class="header-right">
        <div class="meta-item date-box">
          <div class="meta-label">Date</div>
          <input type="date" id="prod-date" />
        </div>

        <div class="meta-item saved-box">
          <div class="meta-label">Last Saved</div>
          <div class="saved-value" id="disp-saved">—</div>
        </div>
      </div>
    </div>

    <!-- =========================================================
         MAIN TABLE
         ========================================================= -->
    <table id="main-table">
      <thead id="table-head"></thead>
      <tbody id="table-body"></tbody>
    </table>

    <!-- =========================================================
         SIGNATURES (PRINT ONLY – lines are for handwriting)
         ========================================================= -->
    <div class="signature-section">
      <div class="sig-box">
        <div class="sig-label">Manager Signature:</div>
        <div class="sig-line"></div>
      </div>
      <div class="sig-box">
        <div class="sig-label">Date:</div>
        <div class="sig-line"></div>
      </div>
    </div>

    <!-- =========================================================
         BUTTONS
         ========================================================= -->
    <div class="btn-row">
      <button id="btn-add" class="btn add" type="button">+ Add Menu Item</button>
      <button id="btn-submit" class="btn lock" type="button">Complete &amp; Lock</button>
      <button id="btn-print" class="btn print" type="button" style="display:none;">Print for Office</button>
      <button id="btn-logout" class="btn logout" type="button">Switch School</button>
    </div>

  </div>

  <!-- =========================================================
       JAVASCRIPT (LOGIC) - everything that controls behavior
       ========================================================= -->
  <script>
    /************************************************************
     * 0) SMALL HELPERS
     ************************************************************/
    const $ = (sel) => document.querySelector(sel);

    function nowTimeString(){
      const d = new Date();
      return d.toLocaleString([], { month:"2-digit", day:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }

    function safeText(el, value){
      if (el) el.textContent = value;
    }

    /************************************************************
     * 1) INITIAL SETUP (school/type from localStorage)
     ************************************************************/
    const schoolName = localStorage.getItem("currentSchool") || "Select School";
    const schoolType = localStorage.getItem("schoolType") || "High School";

    safeText($("#disp-school"), schoolName);
    safeText($("#disp-type"), schoolType);

    // default date = today (ONLY if blank)
    if (!$("#prod-date").value) {
      $("#prod-date").valueAsDate = new Date();
    }

    /************************************************************
     * 2) SAVE KEY (unique per School + Type + Meal + Date)
     ************************************************************/
    function makeSaveKey(){
      const school = (localStorage.getItem("currentSchool") || "UnknownSchool").replace(/\s+/g,"_");
      const typeVal = (localStorage.getItem("schoolType") || "UnknownType").replace(/\s+/g,"_");
      const meal = ($("#meal-picker").value || "UnknownMeal").replace(/\s+/g,"_");
      const dateVal = ($("#prod-date").value || "UnknownDate");
      return `autosave:${school}:${typeVal}:${meal}:${dateVal}`;
    }

    /************************************************************
     * 3) SCHOOL YEAR (July 1 -> June 30)
     ************************************************************/
    function updateSchoolYear(){
      const dateVal = $("#prod-date").value;
      if (!dateVal) return;

      const dateObj = new Date(dateVal + "T00:00:00"); // avoid timezone edge cases
      const year = dateObj.getFullYear();
      const month = dateObj.getMonth(); // 0=Jan, 6=Jul

      let startYear, endYear;
      if (month >= 6) { // July or later
        startYear = year;
        endYear = year + 1;
      } else {
        startYear = year - 1;
        endYear = year;
      }

      $("#disp-schoolyear").textContent = `${startYear} - ${endYear}`;
    }

    /************************************************************
     * 4) TABLE HEADERS (HS vs Elementary)
     ************************************************************/
    function setupHeaders(){
      const head = $("#table-head");
      if (schoolType === "High School"){
        head.innerHTML = `<tr>
          <th>Menu Item (Type to Search)</th><th>Recipe #</th><th>Temp</th>
          <th>Prev</th><th>New</th><th>Total</th>
          <th>Served</th><th>Discard</th><th>Future</th>
        </tr>`;
      } else {
        head.innerHTML = `<tr>
          <th>Menu Item (Type to Search)</th><th>Recipe #</th>
          <th>Prepared</th><th>Leftover</th><th>Discard</th><th>Total Served</th>
        </tr>`;
      }
    }

    /************************************************************
     * 5) MENU DATA (datalist search)
     ************************************************************/
    async function fetchMenuData(){
      try{
        const res = await fetch("src/data/menuItems.json");
        return await res.json();
      } catch(e){
        console.warn("menuItems.json missing or failed. Using backup items.", e);
        return {
          "highSchool": {
            "breakfast": [
              { "item": "Fruit Yogurt Parfait", "recipe": "269133, 14635" },
              { "item": "Stuffed Cinn French Toast", "recipe": "141180" }
            ],
            "lunch": [
              { "item": "Turkey Barbacoa", "recipe": "1498467" }
            ]
          },
          "elementary": {
            "breakfast": [
              { "item": "Cereal", "recipe": "000001" }
            ],
            "lunch": [
              { "item": "Turkey Barbacoa", "recipe": "1498467" }
            ]
          }
        };
      }
    }

    function getListForTypeMeal(menuData){
      const meal = $("#meal-picker").value; // Breakfast/Lunch
      if (schoolType === "High School"){
        return (meal === "Breakfast") ? menuData.highSchool.breakfast : menuData.highSchool.lunch;
      } else {
        return (meal === "Breakfast") ? menuData.elementary.breakfast : menuData.elementary.lunch;
      }
    }

    /************************************************************
     * 6) ADD ROW (supports loading saved row data)
     ************************************************************/
    async function addRow(savedData = null){
      const menuData = await fetchMenuData();
      const list = getListForTypeMeal(menuData);

      const tbody = $("#table-body");
      const tr = document.createElement("tr");
      const uniqueId = Date.now() + Math.random();

      // build datalist options
      let optionsHtml = "";
      list.forEach(x => {
        optionsHtml += `<option value="${escapeHtml(x.item)}" data-recipe="${escapeHtml(x.recipe)}"></option>`;
      });

      if (schoolType === "High School"){
        tr.innerHTML = `
          <td>
            <input list="dl-${uniqueId}" class="item-input" placeholder="Type name..." />
            <datalist id="dl-${uniqueId}">${optionsHtml}</datalist>
          </td>
          <td class="recipe-cell">-</td>
          <td><input class="temp" type="text" style="width:80px" /></td>
          <td><input class="prev" type="number" min="0" step="1" /></td>
          <td><input class="new" type="number" min="0" step="1" /></td>
          <td class="total-p" style="font-weight:900;">0</td>
          <td><input class="serv" type="number" min="0" step="1" /></td>
          <td><input class="disc" type="number" min="0" step="1" /></td>
          <td class="future" style="font-weight:900; color:#0b4aa2;">0</td>
        `;
      } else {
        tr.innerHTML = `
          <td>
            <input list="dl-${uniqueId}" class="item-input" placeholder="Type name..." />
            <datalist id="dl-${uniqueId}">${optionsHtml}</datalist>
          </td>
          <td class="recipe-cell">-</td>
          <td><input class="prep" type="number" min="0" step="1" /></td>
          <td><input class="left" type="number" min="0" step="1" /></td>
          <td><input class="disc" type="number" min="0" step="1" /></td>
          <td class="served" style="font-weight:900; color:#15803d;">0</td>
        `;
      }

      tbody.appendChild(tr);

      // Attach listeners (auto-save + recipe + math)
      const itemInput = tr.querySelector(".item-input");
      itemInput.addEventListener("change", () => { fillRecipe(itemInput); saveToStorage(); });
      itemInput.addEventListener("input", () => { saveToStorage(); });

      tr.querySelectorAll("input").forEach(inp => {
        if (inp.classList.contains("item-input")) return;
        inp.addEventListener("input", () => {
          if (schoolType === "High School") doHSMath(inp);
          else doElemMath(inp);
          saveToStorage();
        });
      });

      // Load saved values into the row (if provided)
      if (savedData){
        const inputs = tr.querySelectorAll("input");
        if (savedData.vals){
          inputs.forEach((inp, i) => {
            if (typeof savedData.vals[i] !== "undefined") inp.value = savedData.vals[i];
          });
        }
        if (savedData.recipe) tr.querySelector(".recipe-cell").textContent = savedData.recipe;

        // Trigger math to recompute
        if (schoolType === "High School") doHSMath(tr.querySelector(".prev") || tr.querySelector("input"));
        else doElemMath(tr.querySelector(".prep") || tr.querySelector("input"));
      }
    }

    /************************************************************
     * 7) RECIPE + MATH
     ************************************************************/
    function fillRecipe(inputEl){
      const row = inputEl.closest("tr");
      const val = inputEl.value;
      const datalist = row.querySelector("datalist");
      const options = datalist ? datalist.options : [];

      for (let i=0; i<options.length; i++){
        if (options[i].value === val){
          row.querySelector(".recipe-cell").textContent = options[i].getAttribute("data-recipe") || "-";
          return;
        }
      }
      row.querySelector(".recipe-cell").textContent = "-";
    }

    function doHSMath(el){
      const row = el.closest("tr");
      const prev = parseFloat(row.querySelector(".prev").value) || 0;
      const newP = parseFloat(row.querySelector(".new").value) || 0;
      const totalP = prev + newP;
      row.querySelector(".total-p").textContent = totalP;

      const serv = parseFloat(row.querySelector(".serv").value) || 0;
      const disc = parseFloat(row.querySelector(".disc").value) || 0;
      row.querySelector(".future").textContent = totalP - serv - disc;
    }

    function doElemMath(el){
      const row = el.closest("tr");
      const prep = parseFloat(row.querySelector(".prep").value) || 0;
      const left = parseFloat(row.querySelector(".left").value) || 0;
      const disc = parseFloat(row.querySelector(".disc").value) || 0;
      row.querySelector(".served").textContent = prep - left - disc;
    }

    /************************************************************
     * 8) AUTO-SAVE (stores table + header inputs)
     ************************************************************/
    function saveToStorage(){
      const key = makeSaveKey();

      // Save rows
      const rows = [];
      document.querySelectorAll("#table-body tr").forEach(tr => {
        const inputVals = Array.from(tr.querySelectorAll("input")).map(i => i.value);
        const recipe = tr.querySelector(".recipe-cell")?.textContent || "-";
        rows.push({ vals: inputVals, recipe });
      });

      localStorage.setItem(key, JSON.stringify(rows));
      localStorage.setItem(key + ":status", localStorage.getItem(key + ":status") || "draft");
      localStorage.setItem(key + ":savedAt", new Date().toISOString());

      // Save header fields
      localStorage.setItem(key + ":mgrName", $("#mgr-name").value || "");
      localStorage.setItem(key + ":students", $("#students-served").value || "");
      localStorage.setItem(key + ":adults", $("#adult-meals").value || "");

      // UI
      $("#disp-saved").textContent = nowTimeString();
    }

    async function loadFromStorage(){
      const key = makeSaveKey();

      // Clear current table
      $("#table-body").innerHTML = "";

      const savedRows = localStorage.getItem(key);
      const savedStatus = localStorage.getItem(key + ":status") || "draft";

      // Restore header fields
      $("#mgr-name").value = localStorage.getItem(key + ":mgrName") || "";
      $("#students-served").value = localStorage.getItem(key + ":students") || "";
      $("#adult-meals").value = localStorage.getItem(key + ":adults") || "";

      // Show last saved timestamp if exists
      const iso = localStorage.getItem(key + ":savedAt");
      $("#disp-saved").textContent = iso ? new Date(iso).toLocaleString() : "—";

      // Restore rows
      if (savedRows){
        const parsed = JSON.parse(savedRows);
        for (const rowData of parsed){
          await addRow(rowData);
        }
      } else {
        await addRow(); // start with one empty row
      }

      // Lock state
      if (savedStatus === "locked"){
        lockForm();
        setStatus("locked");
      } else {
        unlockFormUI();
        setStatus("draft");
      }
    }

    /************************************************************
     * 9) STATUS BADGE (Draft / Locked)
     ************************************************************/
    function setStatus(state){
      const badge = $("#disp-status");
      badge.classList.remove("status-draft","status-locked");
      if (state === "locked"){
        badge.textContent = "LOCKED";
        badge.classList.add("status-locked");
      } else {
        badge.textContent = "DRAFT";
        badge.classList.add("status-draft");
      }
    }

    /************************************************************
     * 10) COMPLETE & LOCK (validation + disable)
     ************************************************************/
    function validateBeforeLock(){
      // Required: date, manager name, students served, adult meals
      if (!$("#prod-date").value){
        alert("Please select a Date.");
        $("#prod-date").focus();
        return false;
      }
      if (!($("#mgr-name").value || "").trim()){
        alert("Manager/Clerk Name (Printed) is required.");
        $("#mgr-name").focus();
        return false;
      }
      if ($("#students-served").value === ""){
        alert("Students Served (Computer Total) is required.");
        $("#students-served").focus();
        return false;
      }
      if ($("#adult-meals").value === ""){
        alert("Adult/Earned Meals is required.");
        $("#adult-meals").focus();
        return false;
      }

      // Optional: at least one menu item typed
      const anyItem = Array.from(document.querySelectorAll(".item-input")).some(inp => (inp.value || "").trim().length > 0);
      if (!anyItem){
        alert("Please enter at least one Menu Item before locking.");
        document.querySelector(".item-input")?.focus();
        return false;
      }
      return true;
    }

    function submitDay(){
      if (!validateBeforeLock()) return;

      if (!confirm("Are you sure you want to finish? You cannot edit the form after this.")) return;

      // save once more
      saveToStorage();

      // lock
      lockForm();

      // store locked status
      const key = makeSaveKey();
      localStorage.setItem(key + ":status", "locked");
      setStatus("locked");
    }

    function lockForm(){
      document.querySelectorAll("input, select").forEach(el => el.disabled = true);
      $("#btn-add").style.display = "none";
      $("#btn-submit").style.display = "none";
      $("#btn-print").style.display = "inline-block";
    }

    function unlockFormUI(){
      document.querySelectorAll("input, select").forEach(el => el.disabled = false);
      $("#btn-add").style.display = "inline-block";
      $("#btn-submit").style.display = "inline-block";
      $("#btn-print").style.display = "none";
    }

    /************************************************************
     * 11) SWITCH SCHOOL
     ************************************************************/
    function logout(){
      // keep autosaves; only switch school/type
      localStorage.removeItem("currentSchool");
      localStorage.removeItem("schoolType");
      window.location.href = "index.html";
    }

    /************************************************************
     * 12) HTML ESCAPE (so item names don’t break the datalist)
     ************************************************************/
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /************************************************************
     * 13) EVENT WIRES (buttons + autosave triggers)
     ************************************************************/
    $("#btn-add").addEventListener("click", () => addRow());
    $("#btn-submit").addEventListener("click", submitDay);
    $("#btn-print").addEventListener("click", () => window.print());
    $("#btn-logout").addEventListener("click", logout);

    // Auto-save header fields
    $("#mgr-name").addEventListener("input", saveToStorage);
    $("#students-served").addEventListener("input", saveToStorage);
    $("#adult-meals").addEventListener("input", saveToStorage);

    // When Date changes: update school year + load that day's data
    $("#prod-date").addEventListener("change", async () => {
      updateSchoolYear();
      await loadFromStorage();
    });

    // When Meal changes: load that meal's data (different save key)
    $("#meal-picker").addEventListener("change", async () => {
      await loadFromStorage();
    });

    /************************************************************
     * 14) INITIALIZE (run once at page load)
     ************************************************************/
    setupHeaders();
    updateSchoolYear();
    loadFromStorage();
  </script>
</body>
</html>
